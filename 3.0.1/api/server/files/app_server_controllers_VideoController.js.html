<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app\server\controllers\VideoController.js - OpenVeo Publish server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Publish server</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 3.0.1
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ConfigurationController.html">ConfigurationController</a></li>
                                <li><a href="../classes/ConfigurationModel.html">ConfigurationModel</a></li>
                                <li><a href="../classes/ConfigurationProvider.html">ConfigurationProvider</a></li>
                                <li><a href="../classes/DirectoryFsWatcher.html">DirectoryFsWatcher</a></li>
                                <li><a href="../classes/DirectoryWatcher.html">DirectoryWatcher</a></li>
                                <li><a href="../classes/ERRORS.html">ERRORS</a></li>
                                <li><a href="../classes/factory.html">factory</a></li>
                                <li><a href="../classes/GoogleOAuthHelper.html">GoogleOAuthHelper</a></li>
                                <li><a href="../classes/HTTP_ERRORS.html">HTTP_ERRORS</a></li>
                                <li><a href="../classes/LocalProvider.html">LocalProvider</a></li>
                                <li><a href="../classes/Package.html">Package</a></li>
                                <li><a href="../classes/PackageError.html">PackageError</a></li>
                                <li><a href="../classes/PropertyController.html">PropertyController</a></li>
                                <li><a href="../classes/PropertyModel.html">PropertyModel</a></li>
                                <li><a href="../classes/PropertyProvider.html">PropertyProvider</a></li>
                                <li><a href="../classes/PublishError.html">PublishError</a></li>
                                <li><a href="../classes/PublishManager.html">PublishManager</a></li>
                                <li><a href="../classes/PublishPlugin.html">PublishPlugin</a></li>
                                <li><a href="../classes/ResumableUpload.html">ResumableUpload</a></li>
                                <li><a href="../classes/STATES.html">STATES</a></li>
                                <li><a href="../classes/StatisticsController.html">StatisticsController</a></li>
                                <li><a href="../classes/TarPackage.html">TarPackage</a></li>
                                <li><a href="../classes/TarPackageError.html">TarPackageError</a></li>
                                <li><a href="../classes/TYPES.html">TYPES</a></li>
                                <li><a href="../classes/VideoController.html">VideoController</a></li>
                                <li><a href="../classes/VideoModel.html">VideoModel</a></li>
                                <li><a href="../classes/VideoPackage.html">VideoPackage</a></li>
                                <li><a href="../classes/VideoPackageError.html">VideoPackageError</a></li>
                                <li><a href="../classes/videoPlatformFactory.html">videoPlatformFactory</a></li>
                                <li><a href="../classes/VideoPlatformProvider.html">VideoPlatformProvider</a></li>
                                <li><a href="../classes/VideoProvider.html">VideoProvider</a></li>
                                <li><a href="../classes/VimeoProvider.html">VimeoProvider</a></li>
                                <li><a href="../classes/Watcher.html">Watcher</a></li>
                                <li><a href="../classes/WatcherError.html">WatcherError</a></li>
                                <li><a href="../classes/WowzaProvider.html">WowzaProvider</a></li>
                                <li><a href="../classes/YoutubeProvider.html">YoutubeProvider</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/controllers.html">controllers</a></li>
                                <li><a href="../modules/models.html">models</a></li>
                                <li><a href="../modules/packages.html">packages</a></li>
                                <li><a href="../modules/providers.html">providers</a></li>
                                <li><a href="../modules/publish.html">publish</a></li>
                                <li><a href="../modules/watcher.html">watcher</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app\server\controllers\VideoController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 * @module controllers
 */

var util = require(&#x27;util&#x27;);
var path = require(&#x27;path&#x27;);
var fs = require(&#x27;fs&#x27;);
var async = require(&#x27;async&#x27;);
var openVeoApi = require(&#x27;@openveo/api&#x27;);
var configDir = openVeoApi.fileSystem.getConfDir();
var HTTP_ERRORS = process.requirePublish(&#x27;app/server/controllers/httpErrors.js&#x27;);
var VideoModel = process.requirePublish(&#x27;app/server/models/VideoModel.js&#x27;);
var VideoProvider = process.requirePublish(&#x27;app/server/providers/VideoProvider.js&#x27;);
var PropertyProvider = process.requirePublish(&#x27;app/server/providers/PropertyProvider.js&#x27;);
var STATES = process.requirePublish(&#x27;app/server/packages/states.js&#x27;);
var PublishManager = process.requirePublish(&#x27;app/server/PublishManager.js&#x27;);
var platforms = require(path.join(configDir, &#x27;publish/videoPlatformConf.json&#x27;));
var AccessError = openVeoApi.errors.AccessError;
var ContentController = openVeoApi.controllers.ContentController;

var multer = require(&#x27;multer&#x27;);
var env = (process.env.NODE_ENV === &#x27;production&#x27;) ? &#x27;prod&#x27; : &#x27;dev&#x27;;

/**
 * Defines a controller to handle actions relative to videos&#x27; routes.
 *
 * @class VideoController
 * @extends ContentController
 * @constructor
 */
function VideoController() {
  VideoController.super_.call(this);
}

module.exports = VideoController;
util.inherits(VideoController, ContentController);

/**
 * Displays video player template.
 *
 * Checks first if the video id is valid and if the video is published
 * before returning the template.
 *
 * @method displayVideoAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.displayVideoAction = function(request, response, next) {
  var publishPlugin;
  var plugins = process.api.getPlugins();
  response.locals.scripts = [];
  response.locals.css = [];

  plugins.forEach(function(subPlugin) {
    if (subPlugin.name === &#x27;publish&#x27;)
      publishPlugin = subPlugin;
  });

  if (publishPlugin) {
    if (publishPlugin.custom) {
      var customScripts = publishPlugin.custom.scriptFiles;
      var playerScripts = customScripts.publishPlayer;
      response.locals.scripts = response.locals.scripts.concat(
        (customScripts.base || []),
        ((playerScripts &amp;&amp; playerScripts[env]) ? playerScripts[env] : [])
      );
      response.locals.css = response.locals.css.concat(publishPlugin.custom.cssFiles || []);
    }
    response.render(&#x27;player&#x27;, response.locals);
  } else
    next();
};

/**
 * Gets all media platforms available.
 *
 * @example
 *     {
 *       &quot;platforms&quot; : [
 *         ...
 *       ]
 *     }
 *
 * @method getPlatformsAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.getPlatformsAction = function(request, response) {
  response.send({
    platforms: Object.keys(platforms) ? Object.keys(platforms).filter(function(value) {
      return platforms[value];
    }) : []
  });
};

/**
 * Gets information about a ready video (state is ready or published).
 *
 * @example
 *     {
 *       video : {
 *         id : 123456789
 *       }
 *     }
 *
 * @method getVideoReadyAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Object} request.params Request&#x27;s parameters
 * @param {String} request.params.id The media id
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.getVideoReadyAction = function(request, response, next) {
  var params;

  try {
    params = openVeoApi.util.shallowValidateObject(request.params, {
      id: {type: &#x27;string&#x27;, required: true}
    });
  } catch (error) {
    return next(HTTP_ERRORS.GET_VIDEO_READY_MISSING_PARAMETERS);
  }

  var model = this.getModel(request);

  model.getOneReady(params.id, function(error, video) {
    if (error &amp;&amp; error instanceof AccessError)
      next(HTTP_ERRORS.GET_VIDEO_READY_FORBIDDEN);
    else if (error || (video.state === STATES.READY &amp;&amp; !request.isAuthenticated()))
      next(HTTP_ERRORS.GET_VIDEO_READY_ERROR);
    else
      response.send({
        entity: video
      });
  });
};

/**
 * Gets published videos by properties.
 *
 * @example
 *     {
 *       &quot;videos&quot; : [
 *         ...
 *       ]
 *     }
 *
 * @method getEntitiesAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Object} request.query Request&#x27;s query parameters
 * @param {String} request.query.query To search on both videos&#x27; title and description
 * @param {String|Array} request.query.states To filter medias by state
 * @param {String} request.query.dateStart To filter medias after or equal to a date (in format mm/dd/yyyy)
 * @param {String} request.query.dateEnd To get medias before a date (in format mm/dd/yyyy)
 * @param {String|Array} request.query.categories To filter medias by category
 * @param {String|Array} request.query.groups To filter medias by group
 * @param {String} request.query.sortBy To sort medias by either **title**, **description** or **date**
 * @param {String} request.query.sortOrder Sort order (either **asc** or **desc**)
 * @param {String} request.query.page The expected page
 * @param {String} request.query.limit To limit the number of medias per page. If not specified get all medias
 * @param {Object} request.query.properties A list of properties with the property id as the key and the expected
 * property value as the value
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.getEntitiesAction = function(request, response, next) {
  var params;
  var model = this.getModel(request);
  var orderedProperties = [&#x27;title&#x27;, &#x27;description&#x27;, &#x27;date&#x27;, &#x27;state&#x27;, &#x27;views&#x27;, &#x27;category&#x27;];

  try {
    params = openVeoApi.util.shallowValidateObject(request.query, {
      query: {type: &#x27;string&#x27;},
      states: {type: &#x27;array&lt;number&gt;&#x27;},
      dateStart: {type: &#x27;date&#x27;},
      dateEnd: {type: &#x27;date&#x27;},
      categories: {type: &#x27;array&lt;string&gt;&#x27;},
      groups: {type: &#x27;array&lt;string&gt;&#x27;},
      user: {type: &#x27;array&lt;string&gt;&#x27;},
      properties: {type: &#x27;object&#x27;, default: {}},
      limit: {type: &#x27;number&#x27;, gt: 0},
      page: {type: &#x27;number&#x27;, gte: 0, default: 0},
      sortBy: {type: &#x27;string&#x27;, in: orderedProperties, default: &#x27;date&#x27;},
      sortOrder: {type: &#x27;string&#x27;, in: [&#x27;asc&#x27;, &#x27;desc&#x27;], default: &#x27;desc&#x27;}
    });
  } catch (error) {
    return next(HTTP_ERRORS.GET_VIDEOS_WRONG_PARAMETERS);
  }

  // Build sort
  var sort = {};
  sort[params.sortBy] = params.sortOrder === &#x27;asc&#x27; ? 1 : -1;

  // Build filter
  var filter = {};

  // Add search query
  if (params.query) {
    filter.$text = {
      $search: &#x27;&quot;&#x27; + params.query + &#x27;&quot;&#x27;
    };
  }

  // Add states
  if (params.states &amp;&amp; params.states.length) {
    filter.state = {
      $in: params.states
    };
  }

  // Add categories
  if (params.categories &amp;&amp; params.categories.length) {
    filter.category = {
      $in: params.categories
    };
  }

  // Add groups
  if (params.groups &amp;&amp; params.groups.length) {
    filter[&#x27;metadata.groups&#x27;] = {
      $in: params.groups
    };
  }

  // Add owner
  if (params.user &amp;&amp; params.user.length) {
    filter[&#x27;metadata.user&#x27;] = {
      $in: params.user
    };
  }

  // Add date
  if (params.dateStart || params.dateEnd) {
    filter.date = {};
    if (params.dateStart) filter.date.$gte = params.dateStart;
    if (params.dateEnd) filter.date.$lt = params.dateEnd;
  }

  // Add custom properties
  if (params.properties) {
    Object.keys(params.properties).forEach(function(propertyId) {
      filter[&#x27;properties.&#x27; + propertyId] = params.properties[propertyId];
    });
  }

  model.getPaginatedFilteredEntities(filter, params.limit, params.page, sort, true,
    function(error, entities, pagination) {
      if (error) {
        process.logger.error(error.message, {error: error, method: &#x27;getEntitiesAction&#x27;});
        next((error instanceof AccessError) ? HTTP_ERRORS.GET_VIDEOS_FORBIDDEN : HTTP_ERRORS.GET_VIDEOS_ERROR);
      } else {
        response.send({
          entities: entities,
          pagination: pagination
        });
      }
    }
  );
};

/**
 * Publishes videos.
 *
 * Change the state of videos to published
 *
 * @method publishVideosAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Object} request.params Request&#x27;s parameters
 * @param {String} request.params.ids A comma separated list of media ids
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.publishVideosAction = function(request, response, next) {
  var params;

  try {
    params = openVeoApi.util.shallowValidateObject(request.params, {
      ids: {type: &#x27;string&#x27;, required: true}
    });
  } catch (error) {
    return next(HTTP_ERRORS.PUBLISH_VIDEO_MISSING_PARAMETERS);
  }

  var ids = params.ids.split(&#x27;,&#x27;);
  var model = this.getModel(request);

  model.publishVideos(ids, function(error) {
    if (error)
      next((error instanceof AccessError) ? HTTP_ERRORS.PUBLISH_VIDEO_FORBIDDEN : HTTP_ERRORS.PUBLISH_VIDEO_ERROR);
    else
      response.send({
        state: STATES.PUBLISHED
      });
  });
};

/**
 * Unpublishes videos.
 *
 * Change the state of videos to unpublished.
 *
 * @method unpublishVideosAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Object} request.params Request&#x27;s parameters
 * @param {String} request.params.ids A comma separated list of media ids
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.unpublishVideosAction = function(request, response, next) {
  var params;

  try {
    params = openVeoApi.util.shallowValidateObject(request.params, {
      ids: {type: &#x27;string&#x27;, required: true}
    });
  } catch (error) {
    return next(HTTP_ERRORS.UNPUBLISH_VIDEO_MISSING_PARAMETERS);
  }

  var ids = params.ids.split(&#x27;,&#x27;);
  var model = this.getModel(request);

  model.unpublishVideos(ids, function(error) {
    if (error)
      next(
        (error instanceof AccessError) ? HTTP_ERRORS.UNPUBLISH_VIDEO_FORBIDDEN : HTTP_ERRORS.UNPUBLISH_VIDEO_ERROR
      );
    else
      response.send({
        state: STATES.READY
      });
  });
};

/**
 * Retries to publish videos on error.
 *
 * @method retryVideosAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Object} request.params Request&#x27;s parameters
 * @param {String} request.params.ids Comma separated list of media ids
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.retryVideosAction = function(request, response, next) {
  var self = this;
  var params;

  try {
    params = openVeoApi.util.shallowValidateObject(request.params, {
      ids: {type: &#x27;string&#x27;, required: true}
    });
  } catch (error) {
    return next(HTTP_ERRORS.RETRY_VIDEO_MISSING_PARAMETERS);
  }

  var ids = params.ids.split(&#x27;,&#x27;);
  var asyncFunctions = [];
  var retryAsyncFunction = function(id) {
    return function(callback) {
      var publishManager = self.getPublishManager();
      publishManager.once(&#x27;retry&#x27;, callback);
      publishManager.retry(id);
    };
  };

  for (var i = 0; i &lt; ids.length; i++)
    asyncFunctions.push(retryAsyncFunction(ids[i]));

  async.parallel(asyncFunctions, function() {
    response.send();
  });
};

/**
 * Starts uploading videos to the media platform.
 *
 * @method startUploadAction
 * @async
 * @param {Request} request ExpressJS HTTP Request
 * @param {Object} request.params Request&#x27;s parameters
 * @param {String} request.params.ids Comma separated list of media ids
 * @param {String} request.params.platform The id of the platform to upload to
 * @param {Response} response ExpressJS HTTP Response
 * @param {Function} next Function to defer execution to the next registered middleware
 */
VideoController.prototype.startUploadAction = function(request, response, next) {
  var params;
  var self = this;

  try {
    params = openVeoApi.util.shallowValidateObject(request.params, {
      ids: {type: &#x27;string&#x27;, required: true},
      platform: {type: &#x27;string&#x27;, required: true}
    });
  } catch (error) {
    return next(HTTP_ERRORS.START_UPLOAD_VIDEO_MISSING_PARAMETERS);
  }

  var ids = params.ids.split(&#x27;,&#x27;);
  var asyncFunctions = [];
  var uploadAsyncFunction = function(id, platform) {
    return function(callback) {
      var publishManager = self.getPublishManager();
      publishManager.once(&#x27;upload&#x27;, callback);
      publishManager.upload(id, platform);
    };
  };

  for (var i = 0; i &lt; ids.length; i++)
    asyncFunctions.push(uploadAsyncFunction(ids[i], params.platform));

  async.parallel(asyncFunctions, function() {
    response.send();
  });
};

/**
 * Gets an instance of the video model.
 *
 * @method getModel
 * @param {Object} request The HTTP request
 * @return {VideoModel} The VideoModel instance
 */
VideoController.prototype.getModel = function(request) {
  var database = process.api.getCoreApi().getDatabase();
  return new VideoModel(
    request.user,
    new VideoProvider(database),
    new PropertyProvider(database)
  );
};

/**
 * Gets PublishManager singleton.
 *
 * @method getPublishManager
 * @return {PublishManager} The PublishManager singleton
 */
VideoController.prototype.getPublishManager = function() {
  return PublishManager.get();
};


/**
 * Handles back office updateTags action to upload files and save associated tags.
 *
 * @method updateTagsAction
 */
VideoController.prototype.updateTagsAction = function(request, response, next) {
  var params;
  try {
    params = openVeoApi.util.shallowValidateObject(request.params, {
      id: {type: &#x27;string&#x27;, required: true}
    });
  } catch (error) {
    return next(HTTP_ERRORS.UPDATE_VIDEO_TAGS_MISSING_PARAMETERS);
  }

  var entityId = params.id;
  var model = this.getModel(request);

  var maxsize = 20 * 1000 * 1000; // in bytes
  var uploadPath = process.rootPublish + &#x27;/assets/player/videos/&#x27; + entityId + &#x27;/uploads/&#x27;;

  openVeoApi.fileSystem.mkdir(uploadPath, function() {

    var storage = multer.diskStorage({
      destination: function(req, file, cb) {
        cb(null, uploadPath);
      },
      filename: function(req, file, cb) {
        var extension = path.extname(file.originalname);
        var basename = path.basename(file.originalname, extension);
        var sanitizedFilename = basename.replace(/[^a-z0-9\-]/gi, &#x27;-&#x27;).replace(/\-{2,}/g, &#x27;-&#x27;).toLowerCase();

        fs.stat(uploadPath + sanitizedFilename + extension, function(error, stat) {
          var uploadedFileName;
          if (error) {
            if (error.code == &#x27;ENOENT&#x27;) { // file does not exist
              uploadedFileName = sanitizedFilename + extension;
            } else {
              return cb(error);
            }
          } else uploadedFileName = sanitizedFilename + &#x27;-&#x27; + Date.now() + extension;

          cb(null, uploadedFileName);
        });
      }
    });

    var upload = multer({
      storage: storage,
      limits: {
        fileSize: maxsize
      }
    });

    upload.single(&#x27;file&#x27;)(request, response, function(err) {
      if (err || !request.body.info) {
        if (err)
          process.logger.error(err.message, {error: err, method: &#x27;updateTagsAction&#x27;});

        // An error occurred when uploading
        return next(HTTP_ERRORS.UPLOAD_TAG_FILE_ERROR);
      }
      var data = JSON.parse(request.body.info);
      var file = request.file;

      model.updateTags(entityId, data, file, function(error, newtag) {
        if (error)
          next((error instanceof AccessError) ?
            HTTP_ERRORS.UPDATE_VIDEO_TAGS_FORBIDDEN : HTTP_ERRORS.UPDATE_VIDEO_TAGS_ERROR);
        else
          response.send(newtag);
      });
    });
  });
};


/**
 * Handles back office removeTags action to remove tags.
 *
 * @method removeTagsAction
 */
VideoController.prototype.removeTagsAction = function(request, response, next) {
  var params;
  try {
    params = openVeoApi.util.shallowValidateObject(request.params, {
      id: {type: &#x27;string&#x27;, required: true}
    });
  } catch (error) {
    return next(HTTP_ERRORS.REMOVE_VIDEO_TAGS_MISSING_PARAMETERS);
  }

  var entityId = params.id;
  var model = this.getModel(request);
  var data = request.body;

  model.removeTags(entityId, data, function(error, deletedTag) {
    if (error)
      next((error instanceof AccessError) ?
        HTTP_ERRORS.REMOVE_VIDEO_TAGS_FORBIDDEN : HTTP_ERRORS.REMOVE_VIDEO_TAGS_FORBIDDEN);
    else
      response.send(deletedTag);
  });
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
