<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app/client/admin/js/ovPub/MediaController.js - OpenVeo Publish AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Publish AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 2.1.1
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/publishService.html">publishService</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.publish.html">ov.publish</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/client/admin/js/ovPub/MediaController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

(function(app) {

  /**
   * Defines the media controller for the medias page.
   */
  function MediaController(
  $scope,
  $filter,
  $location,
  $window,
  $interval,
  entityService,
  publishService,
  utilService,
  properties,
  platforms,
  groups,
  users,
  tableReloadEventService,
  i18nService,
  publishName) {
    var entityType = &#x27;videos&#x27;;

    $scope.properties = properties.data.entities;
    $scope.platforms = platforms.data.platforms;
    $scope.groups = groups.data.entities;
    $scope.users = users.data.entities;

    /*
     *
     * RIGHTS
     *
     */
    $scope.rights = {};
    $scope.rights.publish = $scope.checkAccess(&#x27;publish-publish-&#x27; + entityType);
    $scope.rights.chapter = $scope.checkAccess(&#x27;publish-chapter-&#x27; + entityType);
    $scope.rights.retry = $scope.checkAccess(&#x27;publish-retry-&#x27; + entityType);
    $scope.rights.upload = $scope.checkAccess(&#x27;publish-upload-&#x27; + entityType);

    /*
     * FORM EDIT
     */
    var scopeEditForm = $scope.editFormContainer = {};
    scopeEditForm.model = {};
    scopeEditForm.pendingEdition = false;
    scopeEditForm.pluginName = publishName;

    /*
     * DATATABLE
     */
    var scopeDataTable = $scope.tableContainer = {};
    scopeDataTable.pluginName = publishName;

    /**
     * Gets all categories and add a value for &quot;none&quot;.
     *
     * @param {String} label The label for &quot;no categories&quot;
     * @return {Array} The list of categories
     */
    function getSelectableCategories(label) {
      return [{
        value: null,
        name: $filter(&#x27;translate&#x27;)(label)
      }].concat(publishService.getCategoriesOptions());
    }

    /**
     * Opens a link in a new tab.
     *
     * @param {String} link Destination url
     */
    function goToPath(link) {
      $window.open(link, &#x27;_blank&#x27;);
    }

    /**
     * Opens an alert to display HTML code to share the media.
     *
     * @param {Object} media The media to share
     */
    function shareCode(media) {
      $scope.$emit(&#x27;setAlert&#x27;, &#x27;info&#x27;, [
        $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.SHARECODE&#x27;),
        &#x27;&lt;br&gt;&lt;br&gt;&lt;div class=&quot;well well-sm&quot;&gt;&lt;code&gt;&#x27;,
        &#x27;&amp;lt;iframe width=&quot;768&quot; height=&quot;500&quot; &#x27;,
        &#x27;src=&quot;&#x27; + $location.protocol() + &#x27;://&#x27; + $location.host() + &#x27;:&#x27; + $location.port() + media.link,
        &#x27;?fullscreen&amp;lang=&#x27; + i18nService.getLanguage() + &#x27;&quot;&#x27;,
        &#x27; frameborder=&quot;0&quot;&amp;gt;&amp;lt;/iframe&amp;gt;&#x27;,
        &#x27;&lt;/div&gt;&#x27;
      ].join(&#x27;&#x27;), 0);
    }

    // Iterate through the list of medias, if at least one media
    // is pending, poll each 30 seconds to be informed of
    // its status
    var pollMediasPromise = $interval(function() {
      if (!scopeEditForm.pendingEdition) {
        $scope.$emit(&#x27;setAlert&#x27;, &#x27;info&#x27;, $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.RELOAD&#x27;), 4000);
        entityService.deleteCache(entityType, publishName);
        tableReloadEventService.broadcast();
      }
    }, 30000);

    /**
     * Retries a media which is on error.
     *
     * @param {Array} medias The list of medias to work on
     * @param {Function} reload Function to reload the datatable
     */
    function retryMedia(medias, reload) {
      publishService.retryMedia(medias.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.RETRY_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Asks server to start uploading the media to the chosen platform.
     *
     * @param {Array} medias The list of medias to work on
     * @param {String} platformName The name of platform to upload to
     * @param {Function} reload Function to reload the datatable
     */
    function startMediaUpload(medias, platformName, reload) {
      publishService.startMediaUpload(medias.join(&#x27;,&#x27;), platformName)
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.UPLOAD_START_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Publishes a list of medias.
     *
     * @param {Array} medias The list of media ids to publish
     * @param {Function} reload Function to reload the datatable
     */
    function publishMedia(medias, reload) {
      publishService.publishMedia(medias.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.PUBLISHED_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Unpublishes a list of medias.
     *
     * @param {Array} medias The list of media ids to unpublish
     * @param {Function} reload Function to reload the datatable
     */
    function unpublishMedia(medias, reload) {
      publishService.unpublishMedia(medias.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.UNPUBLISHED_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Removes a list of medias.
     *
     * @param {Array} selected The list of media ids to remove
     * @param {Function} reload Function to reload the datatable
     */
    function removeRows(selected, reload) {
      entityService.removeEntity(entityType, publishName, selected.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.REMOVE_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Saves media information.
     *
     * @param {Object} media Media data
     */
    function saveMedia(media) {
      return entityService.updateEntity(entityType, publishName, media.id, {
        title: media.title,
        description: media.description,
        properties: media.properties,
        category: media.category,
        groups: media.groups,
        user: media.user
      }).then(function() {
        scopeEditForm.pendingEdition = false;
      });
    }

    /**
     * Routes to chapters edition.
     *
     * @param {Object} media The media to edit
     */
    function editChapter(media) {
      $location.path(&#x27;/publish/media/&#x27; + media.id);
    }

    /*
     * FORM EDIT
     */
    scopeEditForm.entityType = entityType;

    var categoriesfield = getSelectableCategories(&#x27;CORE.UI.NONE&#x27;);
    scopeEditForm.fieldsBase = [
      {
        key: &#x27;title&#x27;,
        type: &#x27;horizontalEditableInput&#x27;,
        templateOptions: {
          label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.ATTR_TITLE&#x27;),
          required: true
        }
      },
      {
        key: &#x27;description&#x27;,
        type: &#x27;horizontalEditableInput&#x27;,
        templateOptions: {
          label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.ATTR_DESCRIPTION&#x27;),
          required: true
        }
      },
      {
        key: &#x27;category&#x27;,
        type: &#x27;horizontalEditableSelect&#x27;,
        templateOptions: {
          label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.ATTR_CATEGORY&#x27;),
          options: categoriesfield
        }
      },
      {
        key: &#x27;groups&#x27;,
        type: &#x27;horizontalEditableSelect&#x27;,
        templateOptions: {
          label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.ATTR_GROUPS&#x27;),
          options: utilService.buildSelectOptions($scope.groups)
        },
        ngModelAttrs: {
          &#x27;true&#x27;: {
            value: &#x27;multiple&#x27;
          }
        }
      }
    ];

    /*
     *
     * DATATABLE
     */
    scopeDataTable.entityType = entityType;
    scopeDataTable.cellTheme = &#x27;/publish/be/views/partial/publishCells.html&#x27;;

    scopeDataTable.init = {
      sortBy: &#x27;date&#x27;,
      sortOrder: &#x27;dsc&#x27;,
      notSortBy: [&#x27;mediaId&#x27;]
    };
    var categoriesFilter = getSelectableCategories(&#x27;CORE.UI.ALL&#x27;);
    scopeDataTable.filterBy = [
      {
        key: &#x27;title&#x27;,
        value: &#x27;&#x27;,
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.TITLE_FILTER&#x27;)
      }, {
        key: &#x27;description&#x27;,
        value: &#x27;&#x27;,
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.DESCRIPTION_FILTER&#x27;)
      }, {
        key: &#x27;date&#x27;,
        type: &#x27;date&#x27;,
        value: &#x27;&#x27;,
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.DATE_FILTER&#x27;)
      }, {
        key: &#x27;category&#x27;,
        type: &#x27;select&#x27;,
        value: null,
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.CATEGORY_FILTER&#x27;),

        /*
         * [{
         &quot;value&quot;: &#x27;id&#x27;,
         &quot;name&quot;: &#x27;title&#x27;,
         &quot;children&quot; : &#x27;id1,id2,id3&#x27;
         },
         ...
         ];
         */
        options: categoriesFilter,

        // if enable filter will filter with the selectId AND additionnal id set in the &quot;children&quot; key of each options
        filterWithChildren: true
      }
    ];
    scopeDataTable.header = [
      {
        key: &#x27;title&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.NAME_COLUMN&#x27;),
        class: [&#x27;col-xs-8 col-sm-5&#x27;]
      },
      {
        key: &#x27;mediaId&#x27;,
        type: &#x27;multisources&#x27;,
        name: &#x27;&#x27;,
        class: [&#x27;hidden-xs col-sm-1&#x27;]
      },
      {
        key: &#x27;date&#x27;,
        type: &#x27;date&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.DATE_COLUMN&#x27;),
        class: [&#x27;col-xs-1&#x27;]
      },
      {
        key: &#x27;category&#x27;,
        type: &#x27;category&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.CATEGORY_COLUMN&#x27;),
        class: [&#x27;hidden-xs col-sm-2&#x27;]
      },
      {
        key: &#x27;state&#x27;,
        type: &#x27;status&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.STATUS_COLUMN&#x27;),
        class: [&#x27;col-xs-2&#x27;]
      },
      {
        key: &#x27;action&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.ACTIONS_COLUMN&#x27;),
        class: [&#x27;col-xs-1 col-sm-1&#x27;]
      }];
    scopeDataTable.actions = [
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.VIEW&#x27;),
        condition: function(row) {
          return row.state == 11 || row.state == 12;
        },
        callback: function(row) {
          goToPath(row.link + &#x27;?lang=&#x27; + i18nService.getLanguage());
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.SHARE&#x27;),
        condition: function(row) {
          return row.state == 12;
        },
        callback: function(row) {
          shareCode(row);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.PUBLISH&#x27;),
        condition: function(row) {
          return $scope.rights.publish &amp;&amp;
            $scope.checkContentAccess(row, &#x27;update&#x27;) &amp;&amp;
            row.state == 11 &amp;&amp;
            !row.saving;
        },
        callback: function(row, reload) {
          publishMedia([row.id], reload);
        },
        global: function(selected, reload) {
          publishMedia(selected, reload);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.UNPUBLISH&#x27;),
        condition: function(row) {
          return $scope.rights.publish &amp;&amp;
            $scope.checkContentAccess(row, &#x27;update&#x27;) &amp;&amp;
            row.state == 12 &amp;&amp;
            !row.saving;
        },
        callback: function(row, reload) {
          unpublishMedia([row.id], reload);
        },
        global: function(selected, reload) {
          unpublishMedia(selected, reload);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.CHAPTER_EDIT&#x27;),
        condition: function(row) {
          return $scope.rights.chapter &amp;&amp;
            $scope.checkContentAccess(row, &#x27;update&#x27;) &amp;&amp;
            !row.saving &amp;&amp;
            (row.state == 11 || row.state == 12);
        },
        callback: function(row) {
          editChapter(row);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.RETRY&#x27;),
        condition: function(row) {
          return $scope.rights.retry &amp;&amp; $scope.checkContentAccess(row, &#x27;update&#x27;) &amp;&amp; row.state == 0 &amp;&amp; !row.saving;
        },
        callback: function(row, reload) {
          retryMedia([row.id], reload);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.REMOVE&#x27;),
        condition: function(row) {
          return $scope.checkContentAccess(row, &#x27;delete&#x27;) &amp;&amp;
            !row.locked &amp;&amp;
            !row.saving &amp;&amp;
            (row.state === 6 || row.state === 11 || row.state === 12 || row.state === 0);
        },
        warningPopup: true,
        callback: function(row, reload) {
          removeRows([row.id], reload);
        },
        global: function(selected, reload) {
          removeRows(selected, reload);
        }
      }
    ];

    // Add upload actions
    for (var i = 0; i &lt; $scope.platforms.length; i++) {
      var platformName = $scope.platforms[i];
      scopeDataTable.actions.push({
        label: $filter(&#x27;translate&#x27;)(&#x27;PUBLISH.MEDIAS.UPLOAD_&#x27; + platformName.toUpperCase()),
        condition: function(row) {
          return $scope.rights.upload &amp;&amp; $scope.checkContentAccess(row, &#x27;update&#x27;) &amp;&amp; row.state == 6 &amp;&amp; !row.saving;
        },
        callback: function(row, reload) {
          startMediaUpload([row.id], this.platform, reload);
        },
        platform: platformName
      });
    }

    scopeEditForm.init = function(row) {
      scopeEditForm.fields = angular.copy(scopeEditForm.fieldsBase);
      row.groups = row.metadata.groups;
      row.user = row.metadata.user;

      if (row.metadata.user == $scope.userInfo.id || $scope.userInfo.id == 0) {
        var opt = utilService.buildSelectOptions($scope.users);
        scopeEditForm.fields.push({
          key: &#x27;user&#x27;,
          type: &#x27;horizontalEditableSelect&#x27;,
          templateOptions: {
            label: $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.OWNER&#x27;),
            options: opt
          }
        });
      }

      if ($scope.properties.length)
        scopeEditForm.fields.push({
          noFormControl: true,
          template: &#x27;&lt;hr&gt;&#x27;
        });

      // Create a formly field for each property
      angular.forEach($scope.properties, function(property, index) {
        if (property.type === &#x27;text&#x27;) {
          scopeEditForm.fields.push({
            key: property.id,
            type: &#x27;horizontalEditableInput&#x27;,
            model: row.properties,
            templateOptions: {
              label: property.name || property.id
            }
          });

        } else if (property.type === &#x27;list&#x27;) {

          // Build list options with list values
          var options = [{
            value: &#x27;&#x27;,
            name: $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.EMPTY&#x27;)
          }];

          for (var i = 0; i &lt; property.values.length; i++) {
            options.push({
              value: property.values[i],
              name: property.values[i]
            });
          }

          scopeEditForm.fields.push({
            key: property.id,
            type: &#x27;horizontalEditableSelect&#x27;,
            model: row.properties,
            templateOptions: {
              label: property.name || property.id,
              options: options
            }
          });
        } else if (property.type === &#x27;boolean&#x27;) {
          scopeEditForm.fields.push({
            key: property.id,
            type: &#x27;horizontalEditableCheckbox&#x27;,
            model: row.properties,
            templateOptions: {
              label: property.name || property.id
            }
          });
        }
      });

    };

    scopeEditForm.conditionToggleDetail = function(row) {
      return row.state !== 0;
    };

    scopeEditForm.conditionEditDetail = function(row) {
      return $scope.checkContentAccess(row, &#x27;update&#x27;) &amp;&amp; !row.locked &amp;&amp; row.state !== 0;
    };
    scopeEditForm.onSubmit = function(model) {
      return saveMedia(model);
    };

    // Listen to destroy event on the view to update
    $scope.$on(&#x27;$destroy&#x27;, function() {
      $interval.cancel(pollMediasPromise);
    });
  }

  app.controller(&#x27;MediaController&#x27;, MediaController);
  MediaController.$inject = [
    &#x27;$scope&#x27;,
    &#x27;$filter&#x27;,
    &#x27;$location&#x27;,
    &#x27;$window&#x27;,
    &#x27;$interval&#x27;,
    &#x27;entityService&#x27;,
    &#x27;publishService&#x27;,
    &#x27;utilService&#x27;,
    &#x27;properties&#x27;,
    &#x27;platforms&#x27;,
    &#x27;groups&#x27;,
    &#x27;users&#x27;,
    &#x27;tableReloadEventService&#x27;,
    &#x27;i18nService&#x27;,
    &#x27;publishName&#x27;
  ];

})(angular.module(&#x27;ov.publish&#x27;));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
