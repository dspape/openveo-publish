<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app\client\admin\js\ovPub\VideoController.js - OpenVeo Publish AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Publish AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 1.1.2
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/publishService.html">publishService</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.publish.html">ov.publish</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app\client\admin\js\ovPub\VideoController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

(function(app) {

  /**
   * Defines the video controller for the videos page.
   */
  function VideoController(
  $scope,
  $filter,
  $location,
  $window,
  $interval,
  entityService,
  publishService,
  properties,
  categories,
  platforms,
  tableReloadEventService,
  i18nService) {

    $scope.properties = properties.data.entities;

    // Replace Id in Video by the name of the category
    // Category Id can be overwritten, it is only for display purpose
    $scope.categories = categories.data.taxonomy;
    $scope.platforms = platforms.data.platforms;

    /*
     *
     * RIGHTS
     *
     */
    $scope.rights = {};
    $scope.rights.edit = $scope.checkAccess(&#x27;update-video&#x27;);
    $scope.rights.delete = $scope.checkAccess(&#x27;delete-video&#x27;);
    $scope.rights.publish = $scope.checkAccess(&#x27;publish-video&#x27;);
    $scope.rights.chapter = $scope.checkAccess(&#x27;chapter-video&#x27;);
    $scope.rights.retry = $scope.checkAccess(&#x27;retry-video&#x27;);
    $scope.rights.upload = $scope.checkAccess(&#x27;upload-video&#x27;);

    /*
     * FORM EDIT
     */
    var scopeEditForm = $scope.editFormContainer = {};
    scopeEditForm.model = {};
    scopeEditForm.pendingEdition = false;

    /*
     * DATATABLE
     */
    var scopeDataTable = $scope.tableContainer = {};

    /**
     * Gets all categories and add a value for &quot;none&quot;.
     * @param {String} label The label for &quot;no categories&quot;
     * @return {Array} The list of categories
     */
    function getSelectableCategories(label) {
      return [{
        value: null,
        name: $filter(&#x27;translate&#x27;)(label)
      }].concat(publishService.getCategoriesOptions());
    }

    /**
     * Opens a link in a new tab.
     * @param {String} link Destination url
     */
    function goToPath(link) {
      $window.open(link, &#x27;_blank&#x27;);
    }

    /**
     * Opens an alert to display HTML code to share the video.
     * @param {Object} video The video to share
     */
    function shareCode(video) {
      $scope.$emit(&#x27;setAlert&#x27;, &#x27;info&#x27;, [
        $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.SHARECODE&#x27;),
        &#x27;&lt;br&gt;&lt;br&gt;&lt;div class=&quot;well well-sm&quot;&gt;&lt;code&gt;&#x27;,
        &#x27;&amp;lt;iframe width=&quot;480&quot; height=&quot;270&quot; &#x27;,
        &#x27;src=&quot;&#x27; + $location.protocol() + &#x27;://&#x27; + $location.host() + &#x27;:&#x27; + $location.port() + video.link,
        &#x27;?fullscreen&amp;lang=&#x27; + i18nService.getLanguage() + &#x27;&quot;&#x27;,
        &#x27; frameborder=&quot;0&quot;&amp;gt;&amp;lt;/iframe&amp;gt;&#x27;,
        &#x27;&lt;/div&gt;&#x27;
      ].join(&#x27;&#x27;), 0);
    }

    // Iterate through the list of videos, if at least one video
    // is pending, poll each 30 seconds to be informed of
    // its status
    var pollVideosPromise = $interval(function() {
      if (!scopeEditForm.pendingEdition) {
        $scope.$emit(&#x27;setAlert&#x27;, &#x27;info&#x27;, $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.RELOAD&#x27;), 4000);
        entityService.deleteCache(scopeDataTable.entityType);
        tableReloadEventService.broadcast();
      }
    }, 30000);

    /**
     * Retries a video which is on error.
     * @param {Array} videos The list of videos to work on
     * @param {Function} reload Function to reload the datatable
     */
    function retryVideo(videos, reload) {
      publishService.retryVideo(videos.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.RETRY_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Asks server to start uploading the video to the chosen platform.
     * @param {Array} videos The list of videos to work on
     * @param {String} platformName The name of platform to upload to
     * @param {Function} reload Function to reload the datatable
     */
    function startVideoUpload(videos, platformName, reload) {
      publishService.startVideoUpload(videos.join(&#x27;,&#x27;), platformName)
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.UPLOAD_START_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Publishes a list of videos.
     * @param {Array} videos The list of video ids to publish
     * @param {Function} reload Function to reload the datatable
     */
    function publishVideo(videos, reload) {
      publishService.publishVideo(videos.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.PUBLISHED_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Unpublishes a list of videos.
     * @param {Array} videos The list of video ids to unpublish
     * @param {Function} reload Function to reload the datatable
     */
    function unpublishVideo(videos, reload) {
      publishService.unpublishVideo(videos.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.UNPUBLISHED_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Removes a list of videos.
     * @param {Array} selected The list of video ids to remove
     * @param {Function} reload Function to reload the datatable
     */
    function removeRows(selected, reload) {
      entityService.removeEntity(&#x27;video&#x27;, selected.join(&#x27;,&#x27;))
        .then(function() {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.REMOVE_SUCCESS&#x27;), 4000);
          reload();
        });
    }

    /**
     * Saves video information.
     * @param {Object} video Video data
     */
    function saveVideo(video) {
      return entityService.updateEntity(&#x27;video&#x27;, video.id, {
        title: video.title,
        description: video.description,
        properties: video.properties,
        category: video.category
      }).then(function() {
        scopeEditForm.pendingEdition = false;
      });
    }

    /**
     * Routes to chapters edition.
     * @param {Object} video The video to edit
     */
    function editChapter(video) {
      $location.path(&#x27;/publish/video/&#x27; + video.id);
    }

    /**
     * Gets property name by id.
     * @param {String} id Id of the property
     * @return {String} The property name
     */
    function replacePropIdByName(id) {
      var found = -1;
      for (var i = 0; i &lt; $scope.properties.length &amp;&amp; found &lt; 0; i++) {
        var value = $scope.properties[i];
        if (value.id == String(id)) {
          found = i;
          break;
        }
      }

      if (found != -1)
        return $scope.properties[found].name;
      else
        return id;
    }

    /*
     * FORM EDIT
     */
    scopeEditForm.entityType = &#x27;video&#x27;;

    var categoriesfield = getSelectableCategories(&#x27;UI.NONE&#x27;);
    scopeEditForm.fieldsBase = [
      {
        key: &#x27;title&#x27;,
        type: &#x27;horizontalExtendInput&#x27;,
        templateOptions: {
          label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.ATTR_TITLE&#x27;),
          required: true
        }
      },
      {
        key: &#x27;description&#x27;,
        type: &#x27;horizontalExtendInput&#x27;,
        templateOptions: {
          label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.ATTR_DESCRIPTION&#x27;),
          required: true
        }
      },
      {
        key: &#x27;category&#x27;,
        type: &#x27;horizontalExtendSelect&#x27;,
        templateOptions: {
          label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.ATTR_CATEGORY&#x27;),
          options: categoriesfield
        }
      }
    ];

    /*
     *
     * DATATABLE
     */
    scopeDataTable.entityType = &#x27;video&#x27;;
    scopeDataTable.cellTheme = &#x27;/publish/be/views/partial/publishCells.html&#x27;;

    scopeDataTable.init = {
      sortBy: &#x27;date&#x27;,
      sortOrder: &#x27;dsc&#x27;
    };
    var categoriesFilter = getSelectableCategories(&#x27;UI.ALL&#x27;);
    scopeDataTable.filterBy = [
      {
        key: &#x27;title&#x27;,
        value: &#x27;&#x27;,
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.TITLE_FILTER&#x27;)
      }, {
        key: &#x27;description&#x27;,
        value: &#x27;&#x27;,
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.DESCRIPTION_FILTER&#x27;)
      }, {
        key: &#x27;date&#x27;,
        type: &#x27;date&#x27;,
        value: &#x27;&#x27;,
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.DATE_FILTER&#x27;)
      }, {
        key: &#x27;category&#x27;,
        type: &#x27;select&#x27;,
        value: null,
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.CATEGORY_FILTER&#x27;),

        /*
         * [{
         &quot;value&quot;: &#x27;id&#x27;,
         &quot;name&quot;: &#x27;title&#x27;,
         &quot;children&quot; : &#x27;id1,id2,id3&#x27;
         },
         ...
         ];
         */
        options: categoriesFilter,

        // if enable filter will filter with the selectId AND additionnal id set in the &quot;children&quot; key of each options
        filterWithChildren: true
      }
    ];
    scopeDataTable.header = [
      {
        key: &#x27;title&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.NAME_COLUMN&#x27;),
        class: [&#x27;col-xs-8 col-sm-5&#x27;]
      },
      {
        key: &#x27;date&#x27;,
        type: &#x27;date&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.DATE_COLUMN&#x27;),
        class: [&#x27;col-xs-1&#x27;]
      },
      {
        key: &#x27;category&#x27;,
        type: &#x27;category&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.CATEGORY_COLUMN&#x27;),
        class: [&#x27;hidden-xs col-sm-3&#x27;]
      },
      {
        key: &#x27;state&#x27;,
        type: &#x27;status&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.STATUS_COLUMN&#x27;),
        class: [&#x27;col-xs-2&#x27;]
      },
      {
        key: &#x27;action&#x27;,
        name: $filter(&#x27;translate&#x27;)(&#x27;UI.ACTIONS_COLUMN&#x27;),
        class: [&#x27;col-xs-1 col-sm-1&#x27;]
      }];
    scopeDataTable.actions = [
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;UI.VIEW&#x27;),
        condition: function(row) {
          return row.state == 11 || row.state == 12;
        },
        callback: function(row) {
          goToPath(row.link + &#x27;?lang=&#x27; + i18nService.getLanguage());
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;UI.SHARE&#x27;),
        condition: function(row) {
          return row.state == 12;
        },
        callback: function(row) {
          shareCode(row);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.PUBLISH&#x27;),
        condition: function(row) {
          return $scope.rights.publish &amp;&amp; row.state == 11 &amp;&amp; !row.saving;
        },
        callback: function(row, reload) {
          publishVideo([row.id], reload);
        },
        global: function(selected, reload) {
          publishVideo(selected, reload);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.UNPUBLISH&#x27;),
        condition: function(row) {
          return $scope.rights.publish &amp;&amp; row.state == 12 &amp;&amp; !row.saving;
        },
        callback: function(row, reload) {
          unpublishVideo([row.id], reload);
        },
        global: function(selected, reload) {
          unpublishVideo(selected, reload);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.CHAPTER_EDIT&#x27;),
        condition: function(row) {
          return $scope.rights.chapter &amp;&amp; !row.saving &amp;&amp; (row.state == 11 || row.state == 12);
        },
        callback: function(row) {
          editChapter(row);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.RETRY&#x27;),
        condition: function(row) {
          return $scope.rights.retry &amp;&amp; row.state == 0 &amp;&amp; !row.saving;
        },
        callback: function(row, reload) {
          retryVideo([row.id], reload);
        }
      },
      {
        label: $filter(&#x27;translate&#x27;)(&#x27;UI.REMOVE&#x27;),
        condition: function(row) {
          return $scope.rights.delete &amp;&amp;
            !row.locked &amp;&amp;
            !row.saving &amp;&amp;
            (row.state === 6 || row.state === 11 || row.state === 12 || row.state === 0);
        },
        warningPopup: true,
        callback: function(row, reload) {
          removeRows([row.id], reload);
        },
        global: function(selected, reload) {
          removeRows(selected, reload);
        }
      }
    ];

    // Add upload actions
    for (var i = 0; i &lt; $scope.platforms.length; i++) {
      var platformName = $scope.platforms[i];
      scopeDataTable.actions.push({
        label: $filter(&#x27;translate&#x27;)(&#x27;VIDEOS.UPLOAD_&#x27; + platformName.toUpperCase()),
        condition: function(row) {
          return $scope.rights.upload &amp;&amp; row.state == 6 &amp;&amp; !row.saving;
        },
        callback: function(row, reload) {
          startVideoUpload([row.id], this.platform, reload);
        },
        platform: platformName
      });
    }

    scopeEditForm.init = function(row) {
      scopeEditForm.fields = angular.copy(scopeEditForm.fieldsBase);
      angular.forEach(row.properties, function(value, key) {
        var newField = {
          key: key,
          type: &#x27;horizontalExtendInput&#x27;,
          model: row.properties,
          templateOptions: {
            label: replacePropIdByName(key)
          }
        };
        scopeEditForm.fields.push(newField);
      });
    };

    scopeEditForm.conditionToggleDetail = function(row) {
      return row.state !== 0;
    };

    scopeEditForm.conditionEditDetail = function(row) {
      return $scope.rights.edit &amp;&amp; !row.locked &amp;&amp; row.state !== 0;
    };
    scopeEditForm.onSubmit = function(model) {
      return saveVideo(model);
    };

    // Listen to destroy event on the view to update
    $scope.$on(&#x27;$destroy&#x27;, function() {
      $interval.cancel(pollVideosPromise);
    });
  }

  app.controller(&#x27;VideoController&#x27;, VideoController);
  VideoController.$inject = [
    &#x27;$scope&#x27;,
    &#x27;$filter&#x27;,
    &#x27;$location&#x27;,
    &#x27;$window&#x27;,
    &#x27;$interval&#x27;,
    &#x27;entityService&#x27;,
    &#x27;publishService&#x27;,
    &#x27;properties&#x27;,
    &#x27;categories&#x27;,
    &#x27;platforms&#x27;,
    &#x27;tableReloadEventService&#x27;,
    &#x27;i18nService&#x27;
  ];

})(angular.module(&#x27;ov.publish&#x27;));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
